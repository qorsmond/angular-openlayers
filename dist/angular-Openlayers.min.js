/*! angular-Openlayers 08-02-2014 */
"use strict";angular.module("angular-Openlayers",[]),angular.module("angular-Openlayers").directive("olLayer",function(){return{restrict:"E",require:"^olMap",scope:{lyrOptions:"="},link:function(a,b,c,d){function e(a,b,c){var e=[];angular.forEach(b,function(a){var b=new OpenLayers.LonLat(a.lon,a.lat).transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:3857")),d=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(b.lon,b.lat));if(c){var f=c,g={};angular.forEach(f,function(b){g[b]=a[b]}),d.attributes=g}else d.attributes=a;e.push(d)});var f=new OpenLayers.Layer.Vector(a);f.addFeatures(e),d.addLayer(f)}function f(a,b,c){var e=[],f={internalProjection:new OpenLayers.Projection("EPSG:3857"),externalProjection:new OpenLayers.Projection("EPSG:4326")};angular.forEach(b,function(a){var b=new OpenLayers.Format.WKT(f).read(a.WKT),d=c,g={};angular.forEach(d,function(b){g[b]=a[b]}),b.attributes=g,e.push(b)});var g=new OpenLayers.Layer.Vector(a,{renderers:["SVG"]});g.addFeatures(e),d.addLayer(g);var h=g.getDataExtent();d.setBounds(h)}function g(b,c){var e={internalProjection:new OpenLayers.Projection("EPSG:3857"),externalProjection:new OpenLayers.Projection("EPSG:4326")},f=new OpenLayers.Format.GeoJSON(e).read(c);f&&f.constructor!=Array&&(f=[f]);var g=new OpenLayers.Layer.Vector(b);if(g.addFeatures(f),d.addLayer(g),a.lyrVisable){var h=g.getDataExtent();d.setBounds(h)}}var h=a.lyrOptions;"Points"==h.lyrType&&(console.log("Add points layer"),e(h.lyrName,h.lyrData,h.lyrAttr)),"WKT"==h.lyrType&&(console.log("Add WKT layer"),f(h.lyrName,h.lyrData,h.lyrAttr)),"geoJson"==h.lyrType&&(console.log("Add geoJson layer"),g(h.lyrName,h.lyrData)),a.$watch("lyrOptions.lyrOrder",function(a){d.setLayerOrder(h.lyrName,a)}),a.$watch("lyrOptions.lyrVisable",function(a){d.setLayerVisability(h.lyrName,a)}),a.$watch("lyrOptions.lyrActive",function(a){a&&d.setActiveLayer(h.lyrName)}),a.$watch("lyrOptions.lyrStyle",function(a){a&&d.setLayerStyle(h.lyrName,a)},!0)}}}),angular.module("angular-Openlayers").directive("olMap",["olOutput","$timeout",function(a,b){return{template:'<div class="map"><div ng-transclude></div></div>',restrict:"E",replace:!0,transclude:!0,controller:["$scope",function(a){this.addLayer=function(b){a.addNewLayer(b)},this.setBounds=function(b){a.toExtend(b)},this.setLayerOrder=function(b,c){a.setLayerOrder(b,c)},this.setLayerVisability=function(b,c){a.setLayerVisibility(b,c)},this.setActiveLayer=function(b){a.activateLayer(b)},this.setLayerStyle=function(b,c){a.setLayerStyle(b,c)}}],link:function(c,d,e){function f(a){var b="";angular.forEach(a.attributes,function(a,c){b+="<tr><td>"+c+"</td><td>"+a+"</td></tr>"}),j=new OpenLayers.Popup.FramedCloud("chicken",a.geometry.getBounds().getCenterLonLat(),null,'<div><table class="popuptable">'+b+"</table></div>",null,!0,function(){i.unselectAll()}),a.popup=j,m.addPopup(j)}function g(a){m.removePopup(a.popup),a.popup.destroy(),a.popup=null}function h(){var b=!1;if(i){i.active&&(b=!0),i.unselectAll();var c=m.getControlsByClass("OpenLayers.Control.SelectFeature");c[0].deactivate(),c[0].destroy()}var d=[];i=new OpenLayers.Control.SelectFeature(p,{clickout:!0,toggle:!0,multiple:!1,hover:!1,toggleKey:"ctrlKey",multipleKey:"shiftKey",box:!0,onSelect:function(b){"identify"==n&&f(b),"selectFeature"==n&&(d.push(b.attributes),a.setSelectedFeatures(d))},onUnselect:function(b){if("identify"==n&&g(b),"selectFeature"==n){var c=d.indexOf(b.attributes);d.splice(c,1),a.setSelectedFeatures(d)}}}),m.addControl(i),b&&i.activate()}var i,j,k=new OpenLayers.Control.ZoomBox({alwaysZoom:!0}),l=[k,new OpenLayers.Control.Zoom,new OpenLayers.Control.Navigation,new OpenLayers.Control.Attribution,new OpenLayers.Control.MousePosition],m=new OpenLayers.Map(d[0],{projection:"EPSG:3857",displayProjection:"EPSG:4326",controls:l});m.updateSize();var n="panMap";if(e.addBlankbase){var o=new OpenLayers.Layer("Blankbase",{isBaseLayer:!0});m.addLayer(o)}c.addNewLayer=function(a){m.addLayer(a)},c.toExtend=function(a){m.zoomToExtent(a)},c.setLayerVisibility=function(a,b){var c=m.getLayersByName(a);c[0]&&c[0].setVisibility(b)};var p={};c.activateLayer=function(a){var b=m.getLayersByName(a);b[0]&&(p=b[0],h())};var q=new OpenLayers.Control.CacheWrite({imageFormat:"image/jpeg",eventListeners:{cachefull:function(){alert("Cache full.")}}});m.addControl(q),q.activate();var r=new OpenLayers.Control.CacheRead;m.addControl(r),r.activate(),c.selectFeature=function(){n="selectFeature",i.multiple=!1,i.activate()},c.zoomToActiveExtend=function(){n="zoomToActiveExtend",m.zoomToExtent(p.getDataExtent()),m.updateSize()},c.panMap=function(){n="panMap",i.deactivate(),k.deactivate()},c.zoombox=function(){n="zoomBox",i.deactivate(),k.activate()},c.identify=function(){n="identify",i.activate()},c.labeling=function(a,b){if(n="labeling",a){var c=p.styleMap.styles.default.defaultStyle;c.label="${getLabel}";var d=p.styleMap.styles.select.defaultStyle,e={};e.default=new OpenLayers.Style(c,{context:{getLabel:function(c){var d=b?b:12;return c.layer.map.getZoom()>d?c.attributes[a]:""}}}),e.select=new OpenLayers.Style(d),p.styleMap=new OpenLayers.StyleMap(e)}else p.styleMap.styles.default.defaultStyle.label="";p.redraw()},c.setBackground=function(a){if("Clear"===a){var b=m.getLayersByName("Blankbase")[0];return b.setVisibility(!0),void m.setBaseLayer(b)}var c=m.getLayersByName(a)[0];if(c);else{var d;"OpenStreet"===a&&(d=new OpenLayers.Layer.OSM(a)),"GoogleStreet"===a&&(d=new OpenLayers.Layer.Google(a,{type:google.maps.MapTypeId.ROADMAP,numZoomLevels:20})),"GoogleHybrid"===a&&(d=new OpenLayers.Layer.Google(a,{type:google.maps.MapTypeId.HYBRID,numZoomLevels:20})),"GoogleSatelite"===a&&(d=new OpenLayers.Layer.Google(a,{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:20})),m.addLayer(d),c=m.getLayersByName(a)[0]}c.setVisibility(!0),m.setBaseLayer(c)};var s=[];c.setLayerOrder=function(a,b){s.push({lyr:a,ord:b});var c=m.getLayersByClass("OpenLayers.Layer.Vector");angular.forEach(c,function(a){var b=s.filter(function(b){return b.lyr===a.name});m.setLayerIndex(a,b[0].ord)})},c.setLayerStyle=function(a,b){var c=m.getLayersByName(a);if(c[0]){var d=null;if(b.deflt){var e=b.deflt;d=new OpenLayers.Style({rotation:e.rotation,graphicName:e.graphicName,pointRadius:e.pointRadius,fillColor:e.fillColor,fillOpacity:e.fillOpacity,strokeColor:e.strokeColor,strokeWidth:e.strokeWidth,graphicZIndex:1,label:"${getLabel}",fontColor:e.fontColor?e.fontColor:"black",fontSize:e.fontSize?e.fontSize:"10px",fontFamily:e.fontFamily,fontWeight:e.fontWeight,fontStyle:e.fontStyle,labelAlign:e.labelAlign,labelXOffset:80,labelYOffset:10,labelOutlineColor:e.labelOutlineColor,labelOutlineWidth:e.labelOutlineWidth},{context:{getLabel:function(a){return a.layer.map.getZoom()>12?e.labelField?a.attributes[e.labelField]:"":""}}})}var f=null;if(b.select){var g=b.select;f={pointRadius:g.pointRadius,fillColor:g.fillColor,strokeColor:g.strokeColor,graphicZIndex:2}}var h={};d&&(h.default=d),f&&(h.select=new OpenLayers.Style(f)),c[0].styleMap=new OpenLayers.StyleMap(h),c[0].redraw()}},c.activeThematic=null,c.setLayerThematic=function(a){if("Clear"===a){c.activeThematic=null;var b=new OpenLayers.StyleMap({"default":new OpenLayers.Style(p.styleMap.styles.default.defaultStyle),select:new OpenLayers.Style(p.styleMap.styles.select.defaultStyle)});p.styleMap=b,p.redraw()}if(p){c.activeThematic=a;var d=new OpenLayers.Rule({elseFilter:!0}),e=[d];angular.forEach(a.FilterValues,function(b){var c=new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:a.FilterAttr,value:b.val}),symbolizer:{fillColor:b.colr,fillOpacity:1,strokeColor:"black"}});e.push(c)});var f=p.styleMap.styles.default.defaultStyle;f.label="";var g=p.styleMap.styles.select.defaultStyle,h=new OpenLayers.Style(f,{rules:e}),i=new OpenLayers.StyleMap({"default":h,select:new OpenLayers.Style(g)});p.styleMap=i,p.redraw()}},c.printMap=function(){jQuery("#OpenLayers_Control_Attribution_5").hide(),jQuery(".olControlZoomIn.olButton").hide(),jQuery(".olControlZoomOut.olButton").hide(),jQuery("#OpenLayers_Control_MousePosition_6").hide(),d.css("width","210mm"),d.css("height","210mm"),m.updateSize(),d.hide(),b(function(){d.show();var a=d.html();d.css("width",""),d.css("height",""),m.updateSize(),jQuery("#OpenLayers_Control_Attribution_5").show(),jQuery(".olControlZoomIn.olButton").show(),jQuery(".olControlZoomOut.olButton").show(),jQuery("#OpenLayers_Control_MousePosition_6").show();var b=window.open();b.document.write("<html><head><title>Map</title>"),b.document.write("</head><body >"),b.document.write(a),b.document.write("</body></html>"),b.print(),b.close()},500)},c.setBackground("OpenStreet"),console.log("the map is ready")}}}]),angular.module("angular-Openlayers").factory("olOutput",["$rootScope",function(a){function b(b){c.length=0,angular.forEach(b,function(a){c.push(a)}),a.$apply()}var c=[];return{setSelectedFeatures:b,selectedFeatures:c}}]);